<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ML for Biologists</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <text y='0.9em' font-size='90'>ðŸ§¬</text>
    </svg>">

  <!-- PrismJS -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #222;
      background: #fff;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
    }

    #headerToggle {
      display: none;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      color: #0366d6;
      font-size: 0.95rem;
      cursor: pointer;
    }

    #headerToggle:hover {
      background: #e8f4ff;
      border-color: #0366d6;
    }

    #headerNav {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
    }

    header .nav-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      color: #0366d6;
      font-size: 0.95rem;
      cursor: pointer;
      text-decoration: none;
    }

    header .nav-btn:hover {
      background: #e8f4ff;
      border-color: #0366d6;
    }

    header .nav-btn.active {
      background: #0366d6;
      color: #fff;
      border-color: #0366d6;
    }

    #container {
      display: flex;
      min-height: calc(100vh - 52px);
    }

    nav {
      width: 260px;
      min-width: 220px;
      padding: 1.5rem;
      background: #f6f6f6;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }

    nav h2 {
      margin-top: 0;
      font-size: 1rem;
    }

    #chapterToc ul {
      list-style: none;
      padding-left: 0;
    }

    #chapterToc li {
      margin: 0.4rem 0;
    }

    #chapterToc li.h3 {
      margin-left: 1rem;
    }

    #chapterToc a {
      display: block;
      color: #0366d6;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.9rem;
    }

    #chapterToc a:hover {
      text-decoration: underline;
    }

    #menuToggle {
      display: none;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      background: none;
      border: none;
      cursor: pointer;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    #content {
      max-width: 900px;
      width: 100%;
      padding: clamp(1.5rem, 4vw, 3rem);
      line-height: 1.7;
    }

    h1 { font-size: clamp(1.8rem, 4vw, 2.4rem); }
    h2 { margin-top: 2.5rem; }

    #toTop {
      position: fixed;
      bottom: 1.2rem;
      right: 1.2rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: #333;
      color: #fff;
      font-size: 1.4rem;
      cursor: pointer;
      display: none;
    }

    @media (max-width: 900px) {
      header {
        padding: 0.75rem 1rem;
      }

      #headerToggle {
        display: block;
      }

      #headerNav {
        display: none;
        width: 100%;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #ddd;
      }

      header.expanded #headerNav {
        display: flex;
      }

      #container {
        flex-direction: column;
      }

      main {
        padding: 0 1rem;
      }

      #content {
        padding: 1.5rem 0.75rem;
        max-width: 100%;
      }

      nav {
        width: 100%;
        min-width: 100%;
        padding: 1rem;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }

      #menuToggle {
        display: block;
      }

      nav.collapsed #chapterToc {
        display: none;
      }

      nav.collapsed h2 {
        display: none;
      }
    }

    /* Extra padding for very small screens (phones) */
    @media (max-width: 480px) {
      main {
        padding: 0 0.75rem;
      }

      #content {
        padding: 1.25rem 0.5rem;
      }
    }

    .figure {
      text-align: center;
      margin: 2.5rem auto;
    }
    
    .figure img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    
    .figure .caption {
      font-size: 0.9rem;
      color: #555;
      margin-top: 0.6rem;
      line-height: 1.4;
    }

  </style>
</head>

<body>

<button id="toTop">â†‘</button>

<header>
  <button id="headerToggle" type="button" aria-label="Show chapters">â˜° Chapters</button>
  <div id="headerNav">
    <button class="nav-btn" data-chapter="chapter1" onclick="navigate('chapter1')">Chapter 1</button>
    <button class="nav-btn" data-chapter="chapter2" onclick="navigate('chapter2')">Chapter 2</button>
    <button class="nav-btn" data-chapter="chapter3" onclick="navigate('chapter3')">Chapter 3</button>
    <button class="nav-btn" data-chapter="chapter4" onclick="navigate('chapter4')">Chapter 4</button>
    <button class="nav-btn" data-chapter="Books" onclick="navigate('Books')">Books for Reference</button>
  </div>
</header>

<div id="container">
  <nav>
    <button id="menuToggle">â˜° In this chapter</button>
    <div id="chapterToc">
      <h2>In this chapter</h2>
      <p id="tocPlaceholder" style="color:#666;font-size:0.9rem;">Load a chapter to see sections.</p>
    </div>
  </nav>

  <main>
    <div id="content">Loadingâ€¦</div>
  </main>
</div>

<!-- Marked -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Prism -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

<!-- MathJax -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async></script>

<script>
  const chapters = {
    chapter1: 'chapters/chapter1.md',
    chapter2: 'chapters/chapter2.md',
    chapter3: 'chapters/chapter3.md',
    chapter4: 'chapters/chapter4.md',
    Books: 'chapters/Books.md'
  };

  marked.setOptions({ headerIds: true, mangle: false });

  async function loadChapter(path) {
    const res = await fetch(path);
    let md = await res.text();

    // Preserve $$ blocks before Marked processes them
    // Use a unique marker that won't be HTML-escaped
    const mathBlocks = [];
    let placeholderIndex = 0;
    md = md.replace(/\$\$([\s\S]*?)\$\$/g, (match, content) => {
      const placeholder = `â¦…MATH${placeholderIndex}â¦†`;
      mathBlocks[placeholderIndex] = content.trim();
      placeholderIndex++;
      return placeholder;
    });

    const content = document.getElementById("content");
    let html = marked.parse(md);
    
    // Restore $$ blocks
    mathBlocks.forEach((mathContent, index) => {
      const placeholder = `â¦…MATH${index}â¦†`;
      html = html.replace(new RegExp(placeholder, 'g'), `$$${mathContent}$$`);
    });
    
    // Clean up any <p> tags that wrapped the $$ blocks
    html = html.replace(/<p>\s*\$\$/g, '$$');
    html = html.replace(/\$\$\s*<\/p>/g, '$$');
    html = html.replace(/<p>(\s*\$\$[\s\S]*?\$\$\s*)<\/p>/g, '$1');
    
    // Also handle cases where Marked converted $$ to \[ \]
    html = html.replace(/\\\[/g, '$$');
    html = html.replace(/\\\]/g, '$$');
    // But preserve actual \[ \] that should remain (if any)
    // This is a fallback - the placeholder method should work
    
    content.innerHTML = html;

    generateChapterIndex();
    Prism.highlightAll();
    
    // Wait for MathJax to be ready, then process equations
    if (window.MathJax) {
      await MathJax.startup.promise;
      MathJax.typesetClear([content]);
      await MathJax.typesetPromise([content]);
    }
    
    window.scrollTo({ top: 0 });
  }

  function generateChapterIndex() {
    const content = document.getElementById("content");
    const tocContainer = document.getElementById("chapterToc");
    const placeholder = document.getElementById("tocPlaceholder");
    const headings = [...content.querySelectorAll("h2, h3")];

    // Remove old list if any
    const oldList = tocContainer.querySelector("ul");
    if (oldList) oldList.remove();
    if (placeholder) placeholder.remove();

    if (!headings.length) {
      const p = document.createElement("p");
      p.id = "tocPlaceholder";
      p.style.cssText = "color:#666;font-size:0.9rem;";
      p.textContent = "No sections in this chapter.";
      tocContainer.appendChild(p);
      return;
    }

    const ul = document.createElement("ul");
    headings.forEach(h => {
      const li = document.createElement("li");
      if (h.tagName === "H3") li.className = "h3";

      const a = document.createElement("a");
      a.textContent = h.textContent;
      a.href = "javascript:void(0)";
      a.onclick = () => {
        h.scrollIntoView({
          behavior: "smooth",
          block: "start"
        });
      };
      li.appendChild(a);
      ul.appendChild(li);
    });

    tocContainer.appendChild(ul);
  }

  function setActiveChapterButton(id) {
    document.querySelectorAll("header .nav-btn").forEach(btn => {
      btn.classList.toggle("active", btn.getAttribute("data-chapter") === id);
    });
  }

  function navigate(id) {
    location.hash = id;
    setActiveChapterButton(id);
    loadChapter(chapters[id]);
    document.querySelector("nav").classList.remove("collapsed");
    document.querySelector("header").classList.remove("expanded");
  }

  document.getElementById("headerToggle").onclick = () =>
    document.querySelector("header").classList.toggle("expanded");

  document.getElementById("menuToggle").onclick = () =>
    document.querySelector("nav").classList.toggle("collapsed");

  window.addEventListener("scroll", () =>
    document.getElementById("toTop").style.display =
      window.scrollY > 300 ? "block" : "none"
  );

  document.getElementById("toTop").onclick = () =>
    window.scrollTo({ top: 0, behavior: "smooth" });

  const initial = location.hash.replace("#", "") || "chapter1";
  setActiveChapterButton(initial);
  loadChapter(chapters[initial]);
</script>

</body>
</html>
